#include "MainWindowController.h"
#include "MainWindowView.h"
#include "EventButtonModel.h"

#include <QDateTime>

MainWindowController::MainWindowController(std::shared_ptr<MainWindowView> mainWin, QObject* parent)
	: QObject(parent)
{
	_mainWinView = mainWin;
	_keyboardInputCntrlr = std::make_unique<KeyboardInputController>(_mainWinView);

	_mainWinView->installEventFilter(_keyboardInputCntrlr.get());

	bindCallbackEvents();

	QString formattedDate = getTodaysFormattedDate();
	invokeJsonRequest(formattedDate);
}

void MainWindowController::Show()
{
	_mainWinView->show();
}

//todo: refactor as the requirement is to generate based on games recieved from the json not dates
//this method may still be usfull for generating adjacent days and then storing the json info to disk for recall
//todo: depricated
std::shared_ptr<QList<QString>> MainWindowController::getButtonDatesList()
{
	// Getting the date and subtracting 4 from it so the menu buttons start 4 days before today
	auto dateList = std::make_shared<QList<QString>>();
	QDate todaysDate = QDate::currentDate();
	todaysDate = todaysDate.addDays(-1);

	for (int i = 0; i < 3; ++i)
	{
		QString dateToAdd = "";
		std::string year = std::to_string(todaysDate.year());
		std::string month = (todaysDate.month() > 9) ? std::to_string(todaysDate.month()) : "0" + std::to_string(todaysDate.month());
		std::string day = (todaysDate.day() > 9) ? std::to_string(todaysDate.day()) : "0" + std::to_string(todaysDate.day());

		dateToAdd = QString::fromStdString(year + "-" + month + "-" + day);

		dateList->push_back(dateToAdd);
		todaysDate = todaysDate.addDays(1);
	}

	return dateList;
}

QString MainWindowController::getTodaysFormattedDate()
{
	QDate todaysDate = QDate::currentDate();
	std::string year = std::to_string(todaysDate.year());
	std::string month = (todaysDate.month() > 9) ? std::to_string(todaysDate.month()) : "0" + std::to_string(todaysDate.month());
	std::string day = (todaysDate.day() > 9) ? std::to_string(todaysDate.day()) : "0" + std::to_string(todaysDate.day());

	return QString::fromStdString(year + "-" + month + "-" + day);	
}

void MainWindowController::invokeJsonRequest(const QString& formattedDate)
{
	_requestsObjList = std::make_unique<QList<std::shared_ptr<JsonRequestModel>>>();
	auto jsonRequest = std::make_shared<JsonRequestModel>(this);
	jsonRequest->MakeUrlJsonRequest(formattedDate);
	_requestsObjList->push_back(jsonRequest);
}

void MainWindowController::generateButtonModelsFromDates(const std::shared_ptr<QList<QString>> datesList)
{
	if (_mainWinView != nullptr)
	{
		//todo: instead of generating buttons by a list of dates they need to be generated by the returned json data
		for (auto i = 0; i < datesList->size(); i++)
		{
			auto btnDataModel = std::make_shared<EventButtonModel>();
			btnDataModel->SetObjectName(datesList->at(i));
			btnDataModel->SetImagePath("/test/image/path");
			btnDataModel->SetHeaderText(datesList->at(i) + " Header");
			btnDataModel->SetDescriptionText("Description Text");
			btnDataModel->SetLowerDescriptionText("Lower Description Text");
			btnDataModel->SetThumbnailNameText("The Thumbnail");

			addButtonToMenu(btnDataModel);
		}

		notifyButtonGenerationCompleteSignal();

	}
}

void MainWindowController::addButtonToMenu(const std::shared_ptr<EventButtonModel> model)
{
	_mainWinView->AddNewButtonToMenu(model);
}

void MainWindowController::bindCallbackEvents()
{
	QObject::connect(this, SIGNAL(notifyButtonGenerationCompleteSignal()), _mainWinView.get(), SLOT(OnButtonGenerationCompleted()));
}


